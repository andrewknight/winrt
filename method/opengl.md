# OpenGL and Qt Quick

While the Qt Quick 2 Scene Graph brings [performance gains and API improvements over its predecessor](/appendix/references.md#qt-5-alpha), it also brings a hard dependency on OpenGL, the de-facto industry standard API for cross-platform hardware-accelerated graphics programming. Utilizing OpenGL as the underlying platform for Qt 5's primary UI toolkit keeps the expectation of performance high while eliminating the burden of supporting alternative drawing APIs such as Direct3D or a custom software rasterizer (as was done with Qt Quick 1). The unfortunate reality is that OpenGL is simply unavailable on some platforms and/or hardware - something which, at least superficially, also holds true for WinRT.

While controversial, the lack of OpenGL support should probably come as no surprise, as Microsoft supports their own graphics API, DirectX. On the Windows platform, DirectX has historically held better support from graphics chip vendors compared to OpenGL, largely due to the importance of the PC gaming industry. While Windows has its own OpenGL layer for vendors to implement drivers for, OpenGL becomes a "[legacy graphics](/appendix/msdn.md#opengl)" API in Windows 8. This no doubt has a polarizing effect, with application developers moving toward the better-supported Direct3D API or away from the Windows platform altogether. With the lack of OpenGL on WinRT, DirectX is the only choice for hardware-accelerated 3D graphics there - whether through direct use or via a wrapper library.

## ANGLE
The Almost Native Graphics Layer Engine ([ANGLE](/appendix/references.md#angle-project)) is an open-source project, authored by Google and several collaborating companies, which provides an [OpenGL ES 2](/appendix/terms.md#opengl-es-2) implementation running on top of Direct3D 9. It was originally developed to improve graphics acceleration support in Google's Chromium web engine, particularly for Windows computers with poor or buggy OpenGL drivers yet adequate Direct3D drivers. This translates to better graphics performance in the web browser (i.e. for WebGL applications), while also providing an OpenGL ES implementation for applications which integrate ANGLE into their products. Qt, for example, [adopted ANGLE](/appendix/references.md#graphics-on-windows-from-a-different-angle) as an option for its Windows port improve the out-of-the-box experience with Qt Quick 2. Similarly to Google Chrome and WebGL, the use of ANGLE enables use of Qt Quick on Windows machines which lack proper OpenGL support.

### Integrating with Qt
ANGLE offers a compelling solution to OpenGL on Windows, perhaps even more so than for Desktop, given the complete lack of OpenGL support and universal support for Direct3D 11 on WinRT. To use ANGLE's Direct3D 11 backend, it was first necessary to first upgrade the version of ANGLE used in Qt. This [upgrade landed in Qt 5.1](/appendix/gerrit.md#52810), based on the "dx11-proto" development branch of ANGLE (since then, this "prototype" version of ANGLE became the master branch, making it easier for the Qt Project to track ANGLE upstream). A few additional patches were submitted to resolve some failing test cases(/appendix/gerrit.md#52811) and [crashes](/appendix/gerrit.md#53037), and to make Direct3D 9 and Direct3D 11 codepaths mutually exclusive. By enabling compilation of a Direct3D 11-only version of ANGLE (through the -angle-d3d11 configure option), the groundwork for using ANGLE under WinRT was laid.

After the updated ANGLE integration, further patches of ANGLE could be made within the WinRT branch. Since ANGLE is geared toward Desktop Windows, a [number of modifications](/appendix/gerrit.md#51857) were required in order to support WinRT's windowing system. Additionally, some unsupported Win32 APIs were replaced with supported versions (much like was done to Qt Core at the beginning of the porting process):
 - Thread local storage (TLS) API usage was replaced with usage of the threading attribute, __declspec(thread).
 - LocalAlloc/LocalFree dynamic memory methods were replaced with the newer Heap API methods.
 - Calls to LoadLibrary() were replaced with LoadPackagedLibrary(). In the case of Direct3D 11, they were removed in favor of static initialization of the Direct3D library.

### EGL on WinRT
To support the WinRT windowing system, changes to ANGLE's [EGL](/appendix/terms.md#egl) adaptation also were made. EGL is an abstraction of the platform windowing system and can be used with OpenGL-based technologies to setup native display surfaces. Much like an OpenGL ES chipset vendor would do, ANGLE provides its own implementation of EGL for as an access layer to its version of the OpenGL ES 2 library. Within EGL, native types (e.g. window handles) are mapped to platform-independent EGL types. With this mapping in place, calls made through the EGL API are directed to platform-dependent private implementations, providing a cross-platform API to initializing the windowing system for use with OpenGL.

In ANGLE, the `EGLNativeWindowType` is defined as `HWND` (Win32 window handle), and the `EGLNativeDisplayType` is defined as `HDC` (Win32 device context handle). These types are meaningless under WinRT, and instead defined `ICoreWindow *` (pointer to the `CoreWindow` interface) and `int` (the default for a general identifier). In the private implementation, methods using `EGLNativeDisplayType` required minimal changes: essentially all display-dependent code was simply skipped using conditional compilation. This works because of the Modern UI's simplicity; it requires far less management of window geometry. Because the native display type was defined as an `int`, the only meaningful value is `EGL_DEFAULT_DISPLAY`: this instructs the EGL implementation to access to the default platform display internally, instead of relying on a user-supplied handle. To provide a useful implementation of `EGLNativeWindowType`, WinRT codepaths were inserted so that ANGLE EGL could deal with initialization and state tracking where appropriate. This important for initializing the Direct3D swap chain and managing viewport geometry changes within the Modern UI.

## Enabling Qt Quick 2
Provided compatible hardware, as long as libEGL (the EGL library), libGLESv2 (the OpenGL ES 2 library), and d3dcompiler_46 (the Direct3D shader compiler library) are packaged with the application, it is possible to initialize OpenGL and render scenes within the Modern UI environment. Assuming a JavaScript backend and the Qt Network module are available, this means that Qt Quick 2 can be built as well. While many finer details remained, it was now possible to utilize OpenGL in the Modern UI, and even then Qt Quick SceneGraph.

![Qt OpenGL Demo](/images/qt-opengl.png)
^ Two Qt OpenGL (via ANGLE) demos running simultaneously within the Modern UI.

### Of Shaders and Feature Levels
One of the caveats of ANGLE is that it the Direct3D 11 renderer [dropped support](/appendix/references.md#angle-project-windows-8-rt-app-store-support) for the Direct3D 9 hardware model (while Direct3D 11 supports older hardware, some features are not available for all GPUs). Modern graphics pipelines rely on shader units - programmable cores of the GPU - to process small programs ("shaders") in parallel. While Direct3D 11 is supported on all WinRT devices, feature support (and the associated shader model) can vary. Embedded hardware (as found on phones and tablets) as well as older desktop hardware may be "feature level 9" (for Direct 3D 9) devices, having an effective shader model version 2 (SM2). With WebGL support being the primary use case for ANGLE, the project developers have kept a requirement of SM3 in order to [acheive good WebGL conformance](/appendix/references.md#opengl-insights-angle). Due to these contraints, the ANGLE developers have not targeted SM2 hardware in the Direct3D 11 version. While ANGLE for Direct3D 9 partially supports SM2, it takes advantage of shader model 3 (SM3) wherever possible (as a point of reference, SM4 and SM5 are supported by modern desktop hardware). Unless SM2 support is folded back into ANGLE, these chipsets will remain without Qt Quick 2 suppport.

Even if ANGLE Direct 3D did support SM2 hardware already, Windows Store certification limits use of the Direct3D shader compiler library to development time only; [it cannot be made part of published applications](/appendix/msdn.md#d3dcompilefromfile). This means that developers are responsible for pre-compiling all shader programs used in their application (as opposed to creating them at run-time). This is a challenge for both ANGLE and Qt Quick, which rely on the ability to generate shader programs on-the-fly. ANGLE requires this feature to perform dynamic translation from GLSL to HLSL, while Qt Quick uses the standard OpenGL shader APIs to enable authoring of shaders from interpreted QML code. While applications not destined for the Windows Store (for example, line-of-business applications distributed internally) can ignore this issue, Windows Phone has the additional constraint that it does not ship a shader compiler library at all. This could potentially be aided by a third-party replacement for the Microsoft compiler such as [MojoShader](/appendix/references.md#mojo-shader). The problem remains, however, that Windows Store guidelines prohibit just-in-time code generation in general. A more future-proof option would be a runtime shader cache which collects all of the shaders compiled at development time. These compiled shaders could then be packaged with the application and loaded in place of their dynamically generated variants. Indeed, Direct3D has functions such as [`D3DCreateBlob`](/appendix/msdn.md#d3dcreateblob) that would support this use case, and the situation is expected to get better in [Windows 8.1](/appendix/msdn.md#windows-8.1-directx-programming) with the addition of runtime shader linking support. This is a promising research area, and one which could be rolled up inside the [Qt Scene Graph adaptation layer](/appendix/references.md#scene-graph-adaptation-layer).

### A Cleaner JavaScript
Yet another challenge for Qt Quick 2 is the need for a Windows Store-certifiable JavaScript engine. JavaScript is used as an auxilliary language in QML, allowing scripting and property bindings to work without compilation. Qt 5 ships with Qt V8, an adaptation of the Google V8 JavaScript engine. In order to compile the engine and run it within WinRT, one must disable the API guards which block Win32 APIs from being used. This is because V8, like many scripting engines, relies heavily on the [virtual memory API](/appendix/msdn.md#memory-management-functions) for performing just-in-time ([JIT](/appendix/terms.md#jit)) compilation of JavaScript code. For reasons apparently related to the dynamic code generation constraint, the virtual memory API it is not sanctioned for Windows Store applications, making V8 a non-option for the Windows Store. Fortunately, a solution has been developed in parallel to the WinRT port: the [V4 virtual machine](/appendix/references.md#evolution-of-the-qml-engine-part-1). V4, whose name implies a "trimmed down" version of V8, is an answer to some of the inflexibilities and misaligned use cases of the V8 JavaScript engine. It uses JIT compilation where possible, and falls back to a bytecode interpreter when JIT compilation is not supported. For normal QML use cases, particularly the evaluation of property bindings, V4 promises to have [comparable performance](/appendix/references.md#qml-engine-internals-part-2-bindings) even when JIT compilation is inactive. This helps to reinforce JavaScript as a syntax for use within QML, rather than a complete runtime environment for building up entire applications. C++, after all, is the primary language for use within Qt.

## A Promising Start
Through a combination of ANGLE, V4, and some insights into shader compilation woes, it seems Qt Quick 2 in the Windows Store is a realizable dream. For now, only development-time Qt Quick 2 applications are possible, and only on modern desktop hardware. Certainly, though, a path has been paved for these efforts to continue.

