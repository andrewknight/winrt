# Qt: Tuning up the Tools

Given the breadth of the Qt framework, it is no surprise that it comprises more than just libraries, but also a number of supporting tools. The most advanced of these is Qt Creator, the Qt integrated development environment ([IDE](/appendix/terms.md#ide)). Qt Creator is an open-source desktop application designed to aid in the development and debugging of Qt applications while also supporting general-purpose code editing and project management. Qmake projects (.pro) can be visualized and edited, Qt build tools (such as qmake and linguist) can be invoked, the toolchain can can be used to configure and compile the project, and the resulting application binaries can be interactively launched and debugged. Qt Creator also includes excellent code highlighting, navigation, and auto-completion facilities; particularly in the case of Qt-based technologies like QML. It also hosts a plugin architecture, allowing it to be extended with functionality such as version control integration and device deployment systems.

With any new Qt port, some adjustments to tooling are to be expected; naturally, the more the IDE supports the developer's workflow as well or better than the native tools, there will be an increased uptake and usage of the toolchain. In order to support tooling for WinRT, a plugin for Qt Creator was needed to aid in launching and debugging WinRT applications. Even though Windows developers may use Visual Studio to build their applications, Qt Creator allows an advantage of a familiar, open (and free) environment which works cross-platform. As such, it was imperative that the WinRT plugin could support the most important aspects of WinRT tooling: compilation, packaging, and debugging.

## Application Manifest Generation
The packaging system for Windows Store apps is guided by an application manifest, an XML file containing various metadata about the package. This includes both visual details, such as icons and colors, as well as requested capabilities, such as network or webcam access. While similar, Windows Phone apps use a different packaging convention than other Windows Runtime targets. Given the many options available, and the ease of error when editing the XML by hand, a unified manifest editor was created for Qt Creator (keeping pace with the native IDE, Visual Studio). The Appx manifest is based on Microsoft's public schema and the [open packaging conventions](/appendix/references.md#30-opc-a-new-standard-for-packaging-your-data) and is therefore well-defined and well-suited to be edited by both the user and external tools. The Windows Phone manifest uses a different schema and file name (WMAppManifest.xml), but is also user-editable and follows a similar (albeit simpler) structure to the Appx manifest.

![Manifest Editor](/images/manifest-editor.png)
^ Qt Creator WinRT Manifest Editor

The [manifest editor](/appendix/gerrit.md#57743) consists of a series of collapsible "detail groups" modeled after Qt Creator's "Projects" pane. Grouping similar details and making the groups collapsible allows the user to manage the visibility of a moderate number of options without requiring additional search tools. It may also have an advantage over tabbed-based views (such as Visual Studio's editor) in that the user may have more than one detail group visibile within the same view. Furthermore, it allows for expansion of the editor (such as adding more detail groups) without the risk of running out of horizontal screen space (as would be the case of a tabbed view). It is also consistent with other parts of Qt Creator, which tends to use a flat approach to document editors.

![Package Editor](/images/package-editor.png)
^ Qt Creator Package Manifest Editor, Packaging Details

Perhaps the most important detail group in the manifest editor is the packaging tool. It provides the user with the most basic elements to modify: the project name, publisher information, and architecture information. Filling this detail group ensures that the minimally required elements are specified. Furthermore, validators are in place on all fields so that the user can be made aware of any potential errors within their input.

![Package Editor](/images/tiles-editor.png)
^ Qt Creator Package Manifest Editor, Tile Details

Another helpful graphical aid in the manifest editor is the tile details group, which visualizes the tiles' look and feel on the Windows Start Screen. This tool aims to provide a benefit over the Visual Studio offering, which does not visualize the tile itself (and therefore requires the user to install the application to view the tiles in action). From Qt Creator, the user can modify the various visual properties of the tiles (background color, icon, label) and immediately see how the tile will appear on the Start Screen. The user can even interact with the icon to get a simulation of the "tilt" animations which occur when pressing a tile within the Modern UI.

![Tile Editor](/images/dependency-editor.png)
^ Qt Creator Package Manifest Editor, System Details

Another crucial view is the System details view, where the user can modify the permissions and hardware support required on the end-user device. [Capabilities](/appendix/msdn.md#capability) are essentially permissions for the application to access the user's media library, network, and other software resources. [Requirements](/appendix/msdn.md#devicecapability) act like permissions to hardware resources, with the added constraint that the user's device must also support such features (for example, a phone must have NFC support for the "Proximity" requirement). Dependencies are software packages which must be installed with the application in order for it to work, such as software frameworks. The package management system enables download and installation of these frameworks automatically. This is especially important for Qt, as it will eventually allow the Qt Project (or even third-party developers, for that matter) to distribute official binary packages for applications to rely on, easing development and licensing concerns considerably.

While providing a graphical manifest editor is not a strict requirement for creating a usable Qt experience on WinRT, it should prove beneficial to helping developers tackle this platform-specific detail without significant new learning. The tooltips and error messages are designed to aid the developer in understanding what each component of the package manifest is modified and what it will affect in the application at installation and runtime.

## Application Registration and Launch
After the developer has an application and corresponding manifest, they may register the app and launch it. The Qt Creator plugin makes this possible all from within the IDE. In the Run settings pane, Qt Creator creates a default "run configuration" for launching the application locally; this typically contains a target executable and working directory. As Windows Store apps cannot be directly launched, these fields were removed and replaced with an "Activation ID" field. This activation ID is the same identifier used with [Appx PowerShell "cmdlets"](/appendix/msdn.md#app-installation-cmdlets-in-windows-powershell) or the [PLMDebug](/appendix/msdn.md#plmdebug), command-line tools for installing and launching Appx packages. As it is not likely that the user will know the ID, a "Find..." button is available for picking the application from a list. Inside the application picker, the user can filter out the name of their application. The "arguments" was left available, as the debugger allows for arguments to be passed to the application.

![Appx Launcher](/images/appx-launcher.png)
^ Qt Creator WinRT Application Launcher

In order to launch the app, it must be registered with the Appx package system, so some extra elements were added in order to ease this process. The first time the user arrives at this view, their application will neither be visible in the "Activation ID" field, or available in the "Select Appx Package" dialog, which is available by clicking "Find..." next to the Activation ID field. If they try to launch their application without first choosing an application, the Select Appx Package dialog is automatically opened. At this point, the user should select a previously registered application, or register their application with the system by clicking "Add...". When adding an application, a file dialog appears and directs them to find their application manifest. If an error occurs, the error message is displayed in an alert dialog. The Windows-provided errors are normally sufficient for debugging, as they explain if e.g. a file is missing or there is an error in the manifest. In the special case that there is no developer license installed (or the license has expired), the dialog asks if the user would like to [launch the developer registration tool](/appendix/gerrit.md#56354).

While a standard installation of an Appx package copies itself to a central directory, registration is a virtual installation which is done in-place. This has the advantage that the developer can continue to modify the same files (e.g. images or QML) without re-installing the application. After successful registration (and in all cases where the application is detected as already registered), the Activation ID is filled with the ID obtained from the Appx selection dialog. At this point, the user is ready to launch the application - they simply hit the "Run" or "Debug" buttons in Qt Creator (or use the associated shortcut keys). Internally, the [IApplicationActivationManager interface](/appendix/msdn.md#iapplicationactivationmanager-interface) is used to launch the application. The user may reopen dialog again if they wish to choose a different application; they may also perform some application-specific settings - such as unregister or open appx manifest - through the appx context menu.

## Application Debugging
Once the application is launched, the process identifier (PID) of the app is passed back to the launcher. This PID can be used to monitor the application's lifetime and also forcefully terminate it. Most importantly, though, it can be passed to a debugger. As Qt Creator already supports the Windows command-line debugger (CDB), this is also used in debugging local WinRT applications. After launching the application, Qt Creator instructs CDB to attach to the running process. Qt Creator even includes built-in visualizers for debugging Qt types, giving it an edge over
Visual Studio in that regard (the Visual Studio debugger cannot visualize Qt types out-of-the-box). Since WinRT applications run in fullscreen, it is wise to employ a multi-monitor setup in order to see both the application and the debugger at the same time.

![Debugging](/images/debugging.png)
^ Two-monitor debugging session: Modern UI (left) being debugged from Qt Creato in Desktop mode (right).

Though local debugging only involved new tweaks to existing features, remote debugging with WinRT is an important task which is yet to be finished. Microsoft has unified their remote debugging solution for WinRT through an application called "msvsmon", the Visual Studio Remote Debugging Monitor. It is a service which runs on the client device (the debuggee) and allows a remote machine to launch interactive debugging sessions. Rather than the existing remote debugging protocol used by CDB and WinDebug (supported by Qt Creator), msvsmon uses Windows Web Services (WSSAPI) to communicate over-the-wire. This may not be a complete loss, as WSSAPI applications rely on a schema which can be implemented in a client-agnostic manner. Unfortunately, Microsoft has not made this schema public, making it difficult to interface with msvsmon if this schema is not made available.

### Remote Debugging Insights
In order to understand the relationship between Visual Studio and the various debugging targets (x86 PC, x86 64-bit PC, ARM tablet, x86 Phone Emulator, and ARM Phone), a deeper investigation was made. Through the use of a network monitor (and guidance from the [Windows Phone Power Tools project](/appendix/references.md#31-windows-phone-power-tools)), it was observed that for the emulator and phone, [CoreCon](/appendix/msdn.md#core-connectivity) version 11 (version 10 is used with Windows Phone 7, and earlier versions with Windows CE) is used to facilitate communication. CoreCon is available as .NET managed assembly only, so C++ integration can be done using the Common Language Runtime ([CLR](/appendix/terms.md#clr)). This was explored and tested, but it was found that some of the assemblies were unavailable for 64-bit builds. Thankfully, the Visual Studio 2012 Update 2 includes added a command-line tool, [XapDeployCmd](/appendix/msdn.md#how-to-deploy-and-run-a-windows-phone-app), which covers the use cases of CoreCon without requiring using the API directly (and being a more natural fit for Qt Creator's mentality of controlling external applications).

![Emulators](/images/emulators.png)
^ Several Windows Phone Emulator instances open. Each Emulator provides a different device configuration (e.g. screen resolution & RAM amount).

A major limitation of XapDeployCmd (as well as CoreCon) is the lack of debugging features; it simply offers a way to install, remove, and launch applications. Given this limitation, it is understandable that Visual Studio might use separate tools to launch debug sessions. As it turns out, this is the case: observation of local network traffic suggested that Visual Studio installs and launches msvsmon via CoreCon's RemoteAgent API. The debugging monitor then listens on its normal port, 4016, for Visual Studio to attach to. From there, all communication is done through the msvsmon WSSAPI; debugging objects are passed to Visual Studio and interpreted. This paradigm of deploying and launching the debugger provides potential insight into how Qt Creator might be able to accomplish a similar setup; perhaps even to deploy a third-party debugging helper or remote debugging server.

For non-phone devices, CoreCon is not used in this debugging pipeline (it is a device service which only runs on embedded targets). Rather, msvsmon must be installed manually to the device; it is available as part of the [Windows Remote Debugging Tools from Microsoft](/appendix/msdn.md#running-windows-store-apps-on-a-remote-machine). Once installed, the service is either started manually or configured to run in the background. The debugging session then takes place over the network through Visual Studio, which authenticates with optional encryption. With encryption disabled, the traffic between the debugger and debuggee appeared similar in nature to that of the emulator - that is, XML transactions using the WSSAPI. To reiterate, the ability for Qt Creator to remotely debug these devices lies in the capability to interact with this WSS service, something which is currently not an open API.

While debugging is not yet possible, remote deployment for phone (and phone emulator) was added to the Qt Creator plugin by creating deployment steps for XapDeployCmd. This means that a developer will typically still need to launch Visual Studio if they want an interactive debugging session. For non-phone devices, one potential solution would be to support SSH/SFTP (as is done for Linux devices) or [Windows Remote Management](/appendix/msdn.md#windows-remote-management). That way, CDB could be launched and the existing CDB debugging engine could attach to the session. This, however, doesn't cover ARM devices, which still lack a working solution. As this problem is yet to be solved for Desktop Windows, it may be that a unified approach (including, perhaps deployment from other operating systems) will be attempted in the future.

## A Creative Outlook
While not all use cases are yet covered, it is encouraging to see that Qt Creator can be used for most of the development workflow. Developers can create, register, launch, locally debug, and even package their applications using the IDE. From this foundation, it should be possible to evaluated the developer experience offered by the IDE and platform port when working with WinRT devices.

